# Контроль заряда телефона
Web сервер, при помощи которого можно управлять зарядкой телефона/планшета.
Идея этого проекта сложилась, когда потребовалось установить на планшет панель управления "умным" домом Home Assistant. Дело в том, что постоянно держать на зарядке телефон не очень хорошо: батарея вздувается за короткое время. Нужно было решение, для того что бы поддерживать заряд телефона/планшета на заданном уровне. Эту задачу призван решить данный мини проект. Это форк проекта https://github.com/mendeo/battery_control.
## Принцип работы
Телефон/планшет подключается к системе "умный дом" Home Assistant (HA). На телефоне/планшете запускается специальный web сервер и скрипт, который переодически посылает на web сервер информацию о текущем уровне заряда батарее и другую информацию. HA мониторит уровень заряда телефона. Как только уровень заряда телефона превышает заданный уровень, HA посылает сигнал на "умную" розетку, к которой подключено зарядное устройство телефона, и отключает зарядку. Далее, как только уровень заряда упадёт ниже заданного уровня, то HA снова включит зарядку.  
## Зачем такие сложности?
Действительно, на некоторых рутованных телефонах можно ограничить уровень заряда путём редактированию системных файлов. Но в моём случае это не сработало. К тому же приведенный вариант будет работать практически с любым, даже не рутованным телефоном.
## Скрипт на телефоне
Существует два разных способа запуска скрипта на телефоне: в Termux и в обычном эмуляторе терминала. Запуск через Termux более предпочтительней, т.к. не требует корректировки скрипта и работает сразу. Сейчас используется старый планшет Huawei MediaMate c Android 7.0. Но этот способ не годится для старых телефонов, с версией андроида ниже 7. Можно, конечно, найти старую версию Termux и запустить скрипт даже на 5-ом андроиде, но это требует дополнительных усилий.  
С другой стороны, если у вас рутованый телефон даже со старой версией андроид можно запустить сприпт в любом эмуляторе терминала, но сначала предварительно портребуется установить BusyBox. Из всех утилит BusyBox для работы скрипта требуется wget.  
### Адрес сервера
В скрипте phone.sh по умолчанию задан адрес web сервера http://localhost:8080. На 80 порту запустить сервер не удалось нз-за проблем с доступом к портам ниже 1024. Если вам нужно задать другой ip адрес в скрипте, то это делается в третей строке, в переменной SERVER.
### Перед запуском скрипта в Termux
Сначала нужно установить Termux, а также Termux:API. Далее нужно запустить Termux и установить Termux api:
```bash
pkg install termux-api
```
Это требуется сделать только один раз.
### Перед запуском скрипта на рутованом телефоне в терминале
Сначала нужно переключить скрипт в режим работы без Termux. Для этого в файле phone.sh во второй строке переменной IS_STARTS_FROM_TERMUX нужно выставить значение 0.  
Далее нужно проверить, что скрипт может получить информацию об уровне заряда телефона и о текущем статусе (заряжается, не заряжается). Эти данные берутся из системных файлов. Так в моём телефоне уровень заряда можно увидеть в файле "/sys/class/power_supply/battery/capacity", а информация о статусе в файле "/sys/class/power_supply/battery/status". У вас может быть не так. Поэтому в скрипте нужно задать корректные пути к нужным файлам.  
В файле, содержащем статус батареи находится текстовая информация о том заряжается телефон или нет. Этот текст нужно в точности занести в переменные NOT_CHARGING_STATUS и CHARGING_STATUS. Без информации о статусе батареи и её заряде скрипт работать не будет.  
Также в скрипте есть и другие пути к файлам с данными, например о температуре батареии и другие. Их тоже следует проверить. Но это опционально.  
Далее устанавливаем и запускаем BusyBox, затем нажимаем install в интерфейсе BusyBox и ждём пока всё установится (возможно это потребуется делать после каждой перезагрузки телефона).
### Запуск скрипта
Если запуск ведётся из обычного эмулятора терминала, то скрипт нужно запускать от рута, т.е. сначала выполняем:
```bash
su
```
При работе из Termux этого делать не нужно.  
Далее:
```bash
cd <папка с phone.sh>
sh phone.sh
```
По умолчанию телефон будет заряжаться до 80%. Изменить это значение можно передав новое значение в первом параметре скрипта, например:
```bash
sh phone.sh 50
```
После того, как телефон зарядится до заданного значения он начнёт разряжаться. Снова зарядка включится, когда уровень заряда батареии достигнет уровня на 40% ниже уровня включения зарядки. Это значение так же можно изменить. Во втором параметре к сприпту можно передать уровень, до которого батарея будет разряжаться. Например:
```bash
sh phone.sh 50 40
```
В этом примере телефон будет заряжаться до 50%, потом заряд отключится и снова включится, когда уровень заряда батерии достигнет 40%.
### Еще один способ передать данные на сервер HA
Для передачи данных на сервер используется протокол mqtt. В этом случае на телефон/планшет нужно установить mosquitto. На сервере HA должны быть установлены интеграция MQTT, дополнение mqtt брокер. HA должен быть подписан на соответствующий топик.
В этом случае всю работу выполняет скрипт battery_percentage.sh.
## Web сервер
Web сервер написан на Node.js. Установленная версия Node.js 23.6.1.  
После запуска сервер работает на 8080 порту.  
На странице планируется в будущем отображать трафик телефона. В файле server.js значение переменной TRAFFIC_COMMAND содержит команду, результат выполнения которой будет отображаться в поле Traffic на web странице.  
По адресу "/setBatteryInfo" телефон отправляет информацию о заряде и статусе батареии.  
По запросу на адрес "/getStatus" сервер отправляет json, с информацией, полученной от телефона.  
По запросу на адрес "/startCharge" можно принудительно включить зарядку телефона.  
По запросу на адрес "/stopCharge" можно принудительно выключить зарядку телефона.  
Запрос на адрес "/" возвращает веб страницу. На ней переодически выполняется запрос на "/getStatus" и отображается полученная информация. Поэтому можно в режиме рельного времени наблюдать информацию о статусе телефона.
## Пример автоматизации
В файле automations.yaml приведен фрагмент, отвечающий за автоматизацию зарядки телефона.планшета. 
